<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Fintracker | Valuations</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background-color: #0f1117;
        color: #f4f6fb;
        --panel-bg: rgba(255, 255, 255, 0.04);
        --panel-border: rgba(255, 255, 255, 0.08);
        --text-muted: rgba(244, 246, 251, 0.65);
        --accent: #72e4ff;
        --danger: #ff6b6b;
        --success: #6bffa8;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at 20% -10%, rgba(114, 228, 255, 0.2), transparent 45%),
          radial-gradient(circle at 80% 0%, rgba(107, 255, 168, 0.15), transparent 35%),
          #05060a;
      }

      .app {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 24px 80px;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .panel {
        background: var(--panel-bg);
        border: 1px solid var(--panel-border);
        border-radius: 20px;
        padding: 24px;
        backdrop-filter: blur(20px);
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.35);
      }

      .app__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
      }

      h1 {
        margin: 0;
        font-size: 2rem;
      }

      .subtitle {
        color: var(--text-muted);
        margin-top: 6px;
      }

      .status-chip {
        border-radius: 999px;
        padding: 8px 16px;
        font-size: 0.9rem;
        border: 1px solid var(--panel-border);
        background: rgba(255, 255, 255, 0.04);
      }

      .status-chip[data-state="loading"] {
        border-color: var(--accent);
        color: var(--accent);
      }

      .status-chip[data-state="error"] {
        border-color: var(--danger);
        color: var(--danger);
      }

      .status-chip[data-state="ready"] {
        border-color: var(--success);
        color: var(--success);
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      label {
        font-weight: 600;
      }

      .control {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      input[type="text"] {
        flex: 1;
        min-width: 200px;
        border-radius: 14px;
        border: 1px solid var(--panel-border);
        padding: 14px 16px;
        font-size: 1rem;
        background: rgba(0, 0, 0, 0.25);
        color: inherit;
      }

      input[type="text"]:focus-visible {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
      }

      button {
        border: none;
        border-radius: 14px;
        padding: 14px 22px;
        font-size: 1rem;
        background: linear-gradient(120deg, #7ef6de, #72e4ff);
        color: #05111b;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        box-shadow: 0 15px 25px rgba(114, 228, 255, 0.3);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
      }

      button:not(:disabled):hover {
        transform: translateY(-1px);
      }

      .hint {
        margin: 0;
        font-size: 0.9rem;
        color: var(--text-muted);
      }

      .message {
        margin-top: 8px;
        font-size: 0.95rem;
      }

      .message[data-tone="error"] {
        color: var(--danger);
      }

      .message[data-tone="success"] {
        color: var(--success);
      }

      .meta-grid {
        margin-top: 20px;
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }

      .label {
        display: block;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        margin-bottom: 6px;
      }

      .value-large {
        font-size: 1.6rem;
        font-weight: 600;
      }

      .totals {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 18px;
        margin-top: 20px;
      }

      .table-wrapper {
        margin-top: 20px;
        border-radius: 16px;
        border: 1px solid var(--panel-border);
        overflow: hidden;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
      }

      thead {
        background: rgba(255, 255, 255, 0.05);
      }

      th,
      td {
        padding: 14px 16px;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }

      tbody tr:hover {
        background: rgba(255, 255, 255, 0.03);
      }

      .mono {
        font-family: "JetBrains Mono", "SFMono-Regular", Consolas, monospace;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        border-radius: 999px;
        padding: 4px 10px;
        border: 1px solid var(--panel-border);
        font-size: 0.8rem;
        color: var(--text-muted);
      }

      .badge[data-tone="ok"] {
        color: var(--success);
        border-color: rgba(107, 255, 168, 0.5);
      }

      .badge[data-tone="warning"] {
        color: #ffd66b;
        border-color: rgba(255, 214, 107, 0.5);
      }

      .empty-state {
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
      }

      @media (max-width: 700px) {
        .app__header {
          flex-direction: column;
          align-items: flex-start;
        }

        table {
          font-size: 0.85rem;
        }
      }
    </style>
  </head>
  <body>
    <main class="app">
      <section class="panel">
        <div class="app__header">
          <div>
            <h1>Fintracker</h1>
            <p class="subtitle">Fetch latest valuation snapshots straight from the backend.</p>
          </div>
          <div class="status-chip" id="status-chip" data-state="idle">Idle</div>
        </div>
      </section>

      <section class="panel">
        <form id="account-form">
          <label for="account-id">Account ID</label>
          <div class="control">
            <input id="account-id" name="account" type="text" placeholder="e.g. 8e9d4d54f0b7" required />
            <button type="submit" id="load-btn">Load snapshot</button>
          </div>
          <p class="hint">Use the partition id from <code>data/positions/valuations/dt=*/account=&lt;id&gt;</code>.</p>
          <div class="message" id="feedback" role="status" aria-live="polite"></div>
        </form>

        <div class="meta-grid">
          <div>
            <span class="label">Snapshot date</span>
            <div class="value-large" id="snapshot-date">—</div>
          </div>
          <div>
            <span class="label">Computed at</span>
            <div class="value-large" id="computed-ts">—</div>
          </div>
          <div>
            <span class="label">Account</span>
            <div class="value-large mono" id="account-label">—</div>
          </div>
          <div>
            <span class="label">Source file</span>
            <div class="mono" id="source-file">—</div>
          </div>
        </div>

        <div class="totals">
          <div>
            <span class="label">Total value</span>
            <div class="value-large" id="total-value">—</div>
            <div class="hint" id="base-currency">Base currency —</div>
          </div>
          <div>
            <span class="label">Positions</span>
            <div class="value-large" id="positions-count">—</div>
            <div class="hint" id="ok-positions">OK positions —</div>
          </div>
        </div>
      </section>

      <section class="panel">
        <header>
          <h2 style="margin: 0">Positions</h2>
          <p class="hint" id="rows-summary">No snapshot loaded yet.</p>
        </header>
        <div class="table-wrapper" role="region" aria-live="polite">
          <table>
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Source</th>
                <th>Unit price (USD)</th>
                <th>Quantity</th>
                <th>Value (USD)</th>
              </tr>
            </thead>
            <tbody id="rows-body">
              <tr>
                <td colspan="5" class="empty-state">Enter an account id and load a snapshot to see positions.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <script>
      const dom = {
        statusChip: document.getElementById("status-chip"),
        feedback: document.getElementById("feedback"),
        snapshotDate: document.getElementById("snapshot-date"),
        computedTs: document.getElementById("computed-ts"),
        accountLabel: document.getElementById("account-label"),
        sourceFile: document.getElementById("source-file"),
        totalValue: document.getElementById("total-value"),
        baseCurrency: document.getElementById("base-currency"),
        positionsCount: document.getElementById("positions-count"),
        okPositions: document.getElementById("ok-positions"),
        rowsBody: document.getElementById("rows-body"),
        rowsSummary: document.getElementById("rows-summary"),
        accountInput: document.getElementById("account-id"),
        submitButton: document.getElementById("load-btn"),
        form: document.getElementById("account-form"),
      };

      const STORAGE_KEY = "fintracker.accountId";

      function setStatus(text, state = "idle") {
        dom.statusChip.textContent = text;
        dom.statusChip.dataset.state = state;
      }

      function setFeedback(message = "", tone = "") {
        dom.feedback.textContent = message;
        if (message) {
          dom.feedback.dataset.tone = tone;
        } else {
          delete dom.feedback.dataset.tone;
        }
      }

      function formatDate(value) {
        if (!value) return "—";
        const date = new Date(value);
        if (Number.isNaN(date)) return value;
        return date.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
      }

      function formatDateTime(value) {
        if (!value) return "—";
        const date = new Date(value);
        if (Number.isNaN(date)) return value;
        return date.toLocaleString(undefined, {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
      }

      function formatNumber(value, options = {}) {
        if (value === null || value === undefined || Number.isNaN(value)) return "—";
        return new Intl.NumberFormat(undefined, { maximumFractionDigits: 2, ...options }).format(value);
      }

      function formatCurrency(value, currency) {
        if (value === null || value === undefined || Number.isNaN(value)) return "—";
        try {
          return new Intl.NumberFormat(undefined, {
            style: "currency",
            currency,
            maximumFractionDigits: value >= 1000 ? 0 : 2,
          }).format(value);
        } catch (_) {
          return `${formatNumber(value)} ${currency ?? ""}`.trim();
        }
      }

      function renderRows(rows, baseCurrency) {
        if (!rows || !rows.length) {
          dom.rowsBody.innerHTML =
            '<tr><td colspan="5" class="empty-state">No positions in this snapshot.</td></tr>';
          dom.rowsSummary.textContent = "0 positions.";
          return;
        }

        const fragment = document.createDocumentFragment();
        rows.forEach((row) => {
          const unitPriceUsd = row.unit_price_base;
          const quantity = row.quantity;
          const valueUsd =
            unitPriceUsd !== null && unitPriceUsd !== undefined && quantity !== null && quantity !== undefined
              ? unitPriceUsd * quantity
              : row.value_base;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>
              <div>${row.symbol}</div>
              <div class="hint mono">${row.asset_type ?? ""}</div>
            </td>
            <td>
              ${row.source ?? row.market ?? "—"}
              ${
                row.status && row.status !== "ok"
                  ? `<span class="badge" data-tone="warning" style="margin-left: 8px">${row.status}</span>`
                  : ""
              }
            </td>
            <td class="mono">${formatCurrency(unitPriceUsd, baseCurrency)}</td>
            <td class="mono">${formatNumber(quantity)}</td>
            <td class="mono">${formatCurrency(valueUsd, baseCurrency)}</td>
          `;
          fragment.appendChild(tr);
        });
        dom.rowsBody.replaceChildren(fragment);
        dom.rowsSummary.textContent = `${rows.length} positions (sorted by USD value).`;
      }

      async function loadSnapshot(accountId) {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 30_000);
        setStatus("Loading…", "loading");
        setFeedback("Fetching snapshot…");
        dom.submitButton.disabled = true;

        try {
          const response = await fetch(
            `/api/valuations/latest?account_id=${encodeURIComponent(accountId.trim())}`,
            { signal: controller.signal }
          );

          if (!response.ok) {
            const detail = await response.json().catch(() => ({}));
            throw new Error(detail.detail || `Request failed with status ${response.status}`);
          }

          const payload = await response.json();
          dom.snapshotDate.textContent = formatDate(payload.snapshot_dt);
          dom.computedTs.textContent = formatDateTime(payload.computed_ts);
          dom.accountLabel.textContent = payload.account_id;
          dom.sourceFile.textContent = payload.source_file;
          dom.totalValue.textContent = formatCurrency(
            payload.totals?.total_value_base,
            payload.base_currency || payload.totals?.base_currency
          );
          dom.baseCurrency.textContent = `Base currency ${payload.base_currency || "—"}`;
          dom.positionsCount.textContent = payload.totals?.positions ?? "—";
          dom.okPositions.textContent = `OK positions ${payload.totals?.ok_positions ?? "—"}`;

          renderRows(payload.rows, payload.base_currency);
          setStatus("Fresh snapshot", "ready");
          setFeedback(`Snapshot loaded for account ${payload.account_id}.`, "success");
          localStorage.setItem(STORAGE_KEY, accountId.trim());
        } catch (error) {
          if (error.name === "AbortError") {
            setFeedback("Request timed out. Try again.", "error");
          } else {
            setFeedback(error.message || "Failed to load snapshot.", "error");
          }
          setStatus("Error", "error");
          dom.rowsBody.innerHTML =
            '<tr><td colspan="5" class="empty-state">Could not load positions. Check the account id and try again.</td></tr>';
          dom.rowsSummary.textContent = "Request failed.";
        } finally {
          dom.submitButton.disabled = false;
          clearTimeout(timeout);
        }
      }

      dom.form.addEventListener("submit", (event) => {
        event.preventDefault();
        const accountId = dom.accountInput.value.trim();
        if (!accountId) {
          setFeedback("Please enter an account id.", "error");
          return;
        }
        loadSnapshot(accountId);
      });

      (function bootstrap() {
        const savedAccount = localStorage.getItem(STORAGE_KEY);
        if (savedAccount) {
          dom.accountInput.value = savedAccount;
          setFeedback("Using last account id from this browser.");
          loadSnapshot(savedAccount);
        } else {
          setFeedback("Enter an account id to get started.");
        }
      })();
    </script>
  </body>
</html>
