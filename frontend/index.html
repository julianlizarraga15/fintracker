<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Fintracker | Valuations</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background-color: #0f1117;
        color: #f4f6fb;
        --panel-bg: rgba(255, 255, 255, 0.04);
        --panel-border: rgba(255, 255, 255, 0.08);
        --text-muted: rgba(244, 246, 251, 0.65);
        --accent: #72e4ff;
        --danger: #ff6b6b;
        --success: #6bffa8;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at 20% -10%, rgba(114, 228, 255, 0.2), transparent 45%),
          radial-gradient(circle at 80% 0%, rgba(107, 255, 168, 0.15), transparent 35%),
          #05060a;
      }

      .app {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 24px 80px;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .panel {
        background: var(--panel-bg);
        border: 1px solid var(--panel-border);
        border-radius: 20px;
        padding: 24px;
        backdrop-filter: blur(20px);
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.35);
      }

      .app__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
      }

      h1 {
        margin: 0;
        font-size: 2rem;
      }

      .subtitle {
        color: var(--text-muted);
        margin-top: 6px;
      }

      .status-chip {
        border-radius: 999px;
        padding: 8px 16px;
        font-size: 0.9rem;
        border: 1px solid var(--panel-border);
        background: rgba(255, 255, 255, 0.04);
      }

      .status-chip[data-state="loading"] {
        border-color: var(--accent);
        color: var(--accent);
      }

      .status-chip[data-state="error"] {
        border-color: var(--danger);
        color: var(--danger);
      }

      .status-chip[data-state="ready"] {
        border-color: var(--success);
        color: var(--success);
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      label {
        font-weight: 600;
      }

      .control {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      input[type="text"],
      input[type="password"] {
        flex: 1;
        min-width: 200px;
        border-radius: 14px;
        border: 1px solid var(--panel-border);
        padding: 14px 16px;
        font-size: 1rem;
        background: rgba(0, 0, 0, 0.25);
        color: inherit;
      }

      input[type="text"]:focus-visible,
      input[type="password"]:focus-visible {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
      }

      button {
        border: none;
        border-radius: 14px;
        padding: 14px 22px;
        font-size: 1rem;
        background: linear-gradient(120deg, #7ef6de, #72e4ff);
        color: #05111b;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        box-shadow: 0 15px 25px rgba(114, 228, 255, 0.3);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
      }

      button:not(:disabled):hover {
        transform: translateY(-1px);
      }

      .hint {
        margin: 0;
        font-size: 0.9rem;
        color: var(--text-muted);
      }

      .message {
        margin-top: 8px;
        font-size: 0.95rem;
      }

      .message[data-tone="error"] {
        color: var(--danger);
      }

      .auth-grid {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }

      .login-status {
        font-size: 0.9rem;
        color: var(--text-muted);
      }

      .message[data-tone="success"] {
        color: var(--success);
      }

      .meta-grid {
        margin-top: 20px;
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }

      .label {
        display: block;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        margin-bottom: 6px;
      }

      .value-large {
        font-size: 1.6rem;
        font-weight: 600;
      }

      .totals {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 18px;
        margin-top: 20px;
      }

      .table-wrapper {
        margin-top: 20px;
        border-radius: 16px;
        border: 1px solid var(--panel-border);
        overflow: hidden;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
      }

      thead {
        background: rgba(255, 255, 255, 0.05);
      }

      th,
      td {
        padding: 14px 16px;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }

      tbody tr:hover {
        background: rgba(255, 255, 255, 0.03);
      }

      .mono {
        font-family: "JetBrains Mono", "SFMono-Regular", Consolas, monospace;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        border-radius: 999px;
        padding: 4px 10px;
        border: 1px solid var(--panel-border);
        font-size: 0.8rem;
        color: var(--text-muted);
      }

      .badge[data-tone="ok"] {
        color: var(--success);
        border-color: rgba(107, 255, 168, 0.5);
      }

      .badge[data-tone="warning"] {
        color: #ffd66b;
        border-color: rgba(255, 214, 107, 0.5);
      }

      .toggle-button {
        background: none;
        border: 1px solid var(--panel-border);
        color: var(--accent);
        padding: 4px 8px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.85rem;
        line-height: 1;
      }

      .details-row {
        background: rgba(255, 255, 255, 0.02);
      }

      .details-row table {
        margin-top: 8px;
        font-size: 0.9rem;
      }

      .details-row td {
        border-bottom: none;
      }

      .is-hidden {
        display: none;
      }

      .empty-state {
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
      }

      @media (max-width: 700px) {
        .app__header {
          flex-direction: column;
          align-items: flex-start;
        }

        table {
          font-size: 0.85rem;
        }
      }
    </style>
  </head>
  <body>
    <main class="app">
      <section class="panel">
        <div class="app__header">
          <div>
            <h1>Fintracker</h1>
            <p class="subtitle">Fetch latest valuation snapshots straight from the backend.</p>
          </div>
          <div class="status-chip" id="status-chip" data-state="idle">Idle</div>
        </div>
      </section>

      <section class="panel">
        <form id="login-form">
          <label for="login-username">Demo login</label>
          <div class="auth-grid">
            <input id="login-username" type="text" placeholder="Username" autocomplete="username" required />
            <input
              id="login-password"
              type="password"
              placeholder="Password"
              autocomplete="current-password"
              required
            />
            <button type="submit" id="login-btn">Log in</button>
          </div>
          <p class="login-status" id="login-feedback">Authenticate to fetch valuation snapshots.</p>
        </form>
      </section>

      <section class="panel">
        <form id="account-form">
          <label for="account-id">Account ID</label>
          <div class="control">
            <input id="account-id" name="account" type="text" placeholder="e.g. 8e9d4d54f0b7" required />
            <button type="submit" id="load-btn">Load snapshot</button>
          </div>
          <p class="hint">Use the partition id from <code>data/positions/valuations/dt=*/account=&lt;id&gt;</code>.</p>
          <div class="message" id="feedback" role="status" aria-live="polite"></div>
        </form>

        <div class="meta-grid">
          <div>
            <span class="label">Snapshot date</span>
            <div class="value-large" id="snapshot-date">—</div>
          </div>
          <div>
            <span class="label">Computed at</span>
            <div class="value-large" id="computed-ts">—</div>
          </div>
          <div>
            <span class="label">Account</span>
            <div class="value-large mono" id="account-label">—</div>
          </div>
          <div>
            <span class="label">Source file</span>
            <div class="mono" id="source-file">—</div>
          </div>
        </div>

        <div class="totals">
          <div>
            <span class="label">Total value</span>
            <div class="value-large" id="total-value">—</div>
            <div class="hint" id="base-currency">Base currency —</div>
          </div>
          <div>
            <span class="label">Positions</span>
            <div class="value-large" id="positions-count">—</div>
            <div class="hint" id="ok-positions">OK positions —</div>
          </div>
        </div>
      </section>

      <section class="panel">
        <header>
          <h2 style="margin: 0">Positions</h2>
          <p class="hint" id="rows-summary">No snapshot loaded yet.</p>
        </header>
        <div class="table-wrapper" role="region" aria-live="polite">
          <table>
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Source</th>
                <th>Unit price (USD)</th>
                <th>Quantity</th>
                <th>Value (USD)</th>
              </tr>
            </thead>
            <tbody id="rows-body">
              <tr>
                <td colspan="5" class="empty-state">Enter an account id and load a snapshot to see positions.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <script>
      const dom = {
        statusChip: document.getElementById("status-chip"),
        feedback: document.getElementById("feedback"),
        snapshotDate: document.getElementById("snapshot-date"),
        computedTs: document.getElementById("computed-ts"),
        accountLabel: document.getElementById("account-label"),
        sourceFile: document.getElementById("source-file"),
        totalValue: document.getElementById("total-value"),
        baseCurrency: document.getElementById("base-currency"),
        positionsCount: document.getElementById("positions-count"),
        okPositions: document.getElementById("ok-positions"),
        rowsBody: document.getElementById("rows-body"),
        rowsSummary: document.getElementById("rows-summary"),
        accountInput: document.getElementById("account-id"),
        submitButton: document.getElementById("load-btn"),
        form: document.getElementById("account-form"),
        loginForm: document.getElementById("login-form"),
        loginFeedback: document.getElementById("login-feedback"),
        loginButton: document.getElementById("login-btn"),
        loginUsername: document.getElementById("login-username"),
        loginPassword: document.getElementById("login-password"),
      };

      const STORAGE_KEY = "fintracker.accountId";
      const REQUEST_TIMEOUT_MS = 30_000;

      const authState = {
        token: null,
        expiresAt: 0,
      };

      function setStatus(text, state = "idle") {
        dom.statusChip.textContent = text;
        dom.statusChip.dataset.state = state;
      }

      function setFeedback(message = "", tone = "") {
        dom.feedback.textContent = message;
        if (message) {
          dom.feedback.dataset.tone = tone;
        } else {
          delete dom.feedback.dataset.tone;
        }
      }

      function setLoginFeedback(message = "", tone = "") {
        dom.loginFeedback.textContent = message;
        if (tone) {
          dom.loginFeedback.dataset.tone = tone;
        } else {
          delete dom.loginFeedback.dataset.tone;
        }
      }

      function hasValidToken() {
        return Boolean(authState.token && authState.expiresAt > Date.now());
      }

      function clearAuthState(message) {
        authState.token = null;
        authState.expiresAt = 0;
        if (message) {
          setLoginFeedback(message, "error");
        }
        dom.loginPassword.value = "";
      }

      async function authenticate(username, password) {
        dom.loginButton.disabled = true;
        setLoginFeedback("Authenticating…");
        try {
          const response = await fetch("/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });
          const payload = await response.json().catch(() => ({}));
          if (!response.ok) {
            const detail = payload && payload.detail;
            throw new Error(detail || "Login failed.");
          }
          authState.token = payload.access_token;
          const expiresInSeconds = Number(payload.expires_in) || 0;
          authState.expiresAt = Date.now() + expiresInSeconds * 1000;
          setLoginFeedback("Authenticated. Token stored in memory.", "success");
          setStatus("Authenticated", "ready");
          if (dom.accountInput.value.trim()) {
            loadSnapshot(dom.accountInput.value.trim());
          }
        } catch (error) {
          clearAuthState();
          setStatus("Auth failed", "error");
          setLoginFeedback(error.message || "Failed to authenticate.", "error");
          dom.loginUsername.focus();
        } finally {
          dom.loginButton.disabled = false;
        }
      }

      function ensureAuthenticated() {
        if (hasValidToken()) {
          return true;
        }
        clearAuthState("Session missing or expired. Log in to continue.");
        dom.loginUsername.focus();
        return false;
      }

      function formatDate(value) {
        if (!value) return "—";
        const date = new Date(value);
        if (Number.isNaN(date)) return value;
        return date.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
      }

      function formatDateTime(value) {
        if (!value) return "—";
        const date = new Date(value);
        if (Number.isNaN(date)) return value;
        return date.toLocaleString(undefined, {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
      }

      function formatNumber(value, options = {}) {
        if (value === null || value === undefined || Number.isNaN(value)) return "—";
        return new Intl.NumberFormat(undefined, { maximumFractionDigits: 2, ...options }).format(value);
      }

      function formatCurrency(value, currency) {
        if (value === null || value === undefined || Number.isNaN(value)) return "—";
        try {
          return new Intl.NumberFormat(undefined, {
            style: "currency",
            currency,
            maximumFractionDigits: value >= 1000 ? 0 : 2,
          }).format(value);
        } catch (_) {
          return `${formatNumber(value)} ${currency ?? ""}`.trim();
        }
      }

      function renderRows(rows, baseCurrency) {
        if (!rows || !rows.length) {
          dom.rowsBody.innerHTML =
            '<tr><td colspan="5" class="empty-state">No positions in this snapshot.</td></tr>';
          dom.rowsSummary.textContent = "0 positions.";
          return;
        }

        const groupMap = new Map();
        rows.forEach((row) => {
          if (!groupMap.has(row.symbol)) groupMap.set(row.symbol, []);
          groupMap.get(row.symbol).push(row);
        });

        const groups = Array.from(groupMap.entries()).map(([symbol, symbolRows]) => {
          const totalQuantity = symbolRows.reduce((sum, r) => sum + (r.quantity ?? 0), 0);
          const totalValue = symbolRows.reduce((sum, r) => {
            const unitPrice = r.unit_price_base;
            const qty = r.quantity;
            const value =
              unitPrice !== null && unitPrice !== undefined && qty !== null && qty !== undefined
                ? unitPrice * qty
                : r.value_base;
            return value !== null && value !== undefined ? sum + value : sum;
          }, 0);
          const averagePrice = totalQuantity > 0 ? totalValue / totalQuantity : null;
          return { symbol, rows: symbolRows, totalQuantity, totalValue, averagePrice };
        });

        groups.sort((a, b) => (b.totalValue || 0) - (a.totalValue || 0));

        const fragment = document.createDocumentFragment();
        groups.forEach((group, index) => {
          const toggleId = `details-${index}`;
          const hasDetails = group.rows.length > 1;
          const summarySources = Array.from(
            new Set(group.rows.map((r) => r.source || r.market || "Unknown"))
          );

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>
              <div>${group.symbol}</div>
              <div class="hint mono">${group.rows[0]?.asset_type ?? ""}</div>
            </td>
            <td>
              ${summarySources.join(", ")}
              ${
                hasDetails
                  ? `<button class="toggle-button" type="button" data-toggle-details="${toggleId}" aria-expanded="false" aria-label="Toggle details">></button>`
                  : ""
              }
            </td>
            <td class="mono">${formatCurrency(group.averagePrice, baseCurrency)}</td>
            <td class="mono">${formatNumber(group.totalQuantity)}</td>
            <td class="mono">${formatCurrency(group.totalValue, baseCurrency)}</td>
          `;
          fragment.appendChild(tr);

          if (!hasDetails) {
            return;
          }

          const detailRow = document.createElement("tr");
          detailRow.id = toggleId;
          detailRow.className = "details-row is-hidden";
          const detailCell = document.createElement("td");
          detailCell.colSpan = 5;

          const innerTable = document.createElement("table");
          innerTable.innerHTML = `
            <thead>
              <tr>
                <th>Source</th>
                <th>Unit price (USD)</th>
                <th>Quantity</th>
                <th>Value (USD)</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${group.rows
                .map((row) => {
                  const unitPriceUsd = row.unit_price_base;
                  const quantity = row.quantity;
                  const valueUsd =
                    unitPriceUsd !== null && unitPriceUsd !== undefined && quantity !== null && quantity !== undefined
                      ? unitPriceUsd * quantity
                      : row.value_base;
                  return `
                    <tr>
                      <td>${row.source ?? row.market ?? "—"}</td>
                      <td class="mono">${formatCurrency(unitPriceUsd, baseCurrency)}</td>
                      <td class="mono">${formatNumber(quantity)}</td>
                      <td class="mono">${formatCurrency(valueUsd, baseCurrency)}</td>
                      <td>
                        ${
                          row.status
                            ? `<span class="badge" data-tone="${row.status === "ok" ? "ok" : "warning"}">${row.status}</span>`
                            : ""
                        }
                      </td>
                    </tr>
                  `;
                })
                .join("")}
            </tbody>
          `;

          detailCell.appendChild(innerTable);
          detailRow.appendChild(detailCell);
          fragment.appendChild(detailRow);
        });
        dom.rowsBody.replaceChildren(fragment);
        dom.rowsSummary.textContent = `${rows.length} positions (grouped by symbol, sorted by USD value).`;
      }

      function authHeaders() {
        return hasValidToken() ? { Authorization: `Bearer ${authState.token}` } : {};
      }

      function handleUnauthorized() {
        clearAuthState("Session expired. Please log in again.");
        setStatus("Auth required", "error");
      }

      async function loadSnapshot(accountId) {
        if (!ensureAuthenticated()) {
          setFeedback("Please log in before loading a snapshot.", "error");
          return;
        }
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), REQUEST_TIMEOUT_MS);
        setStatus("Loading…", "loading");
        setFeedback("Fetching snapshot…");
        dom.submitButton.disabled = true;

        try {
          const response = await fetch(
            `/api/valuations/latest?account_id=${encodeURIComponent(accountId.trim())}`,
            { signal: controller.signal, headers: authHeaders() }
          );

          if (!response.ok) {
            if (response.status === 401) {
              handleUnauthorized();
            }
            const detail = await response.json().catch(() => ({}));
            throw new Error(detail.detail || `Request failed with status ${response.status}`);
          }

          const payload = await response.json();
          dom.snapshotDate.textContent = formatDate(payload.snapshot_dt);
          dom.computedTs.textContent = formatDateTime(payload.computed_ts);
          dom.accountLabel.textContent = payload.account_id;
          dom.sourceFile.textContent = payload.source_file;
          dom.totalValue.textContent = formatCurrency(
            payload.totals?.total_value_base,
            payload.base_currency || payload.totals?.base_currency
          );
          dom.baseCurrency.textContent = `Base currency ${payload.base_currency || "—"}`;
          dom.positionsCount.textContent = payload.totals?.positions ?? "—";
          dom.okPositions.textContent = `OK positions ${payload.totals?.ok_positions ?? "—"}`;

          renderRows(payload.rows, payload.base_currency);
          setStatus("Fresh snapshot", "ready");
          setFeedback(`Snapshot loaded for account ${payload.account_id}.`, "success");
          localStorage.setItem(STORAGE_KEY, accountId.trim());
        } catch (error) {
          if (error.name === "AbortError") {
            setFeedback("Request timed out. Try again.", "error");
          } else {
            setFeedback(error.message || "Failed to load snapshot.", "error");
          }
          setStatus("Error", "error");
          dom.rowsBody.innerHTML =
            '<tr><td colspan="5" class="empty-state">Could not load positions. Check the account id and try again.</td></tr>';
          dom.rowsSummary.textContent = "Request failed.";
        } finally {
          dom.submitButton.disabled = false;
          clearTimeout(timeout);
        }
      }

      dom.form.addEventListener("submit", (event) => {
        event.preventDefault();
        const accountId = dom.accountInput.value.trim();
        if (!accountId) {
          setFeedback("Please enter an account id.", "error");
          return;
        }
        loadSnapshot(accountId);
      });

      dom.loginForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const username = dom.loginUsername.value.trim();
        const password = dom.loginPassword.value;
        if (!username || !password) {
          setLoginFeedback("Enter both username and password.", "error");
          return;
        }
        authenticate(username, password);
      });

      (function bootstrap() {
        const savedAccount = localStorage.getItem(STORAGE_KEY);
        if (savedAccount) {
          dom.accountInput.value = savedAccount;
          setFeedback("Account id restored. Log in and load the snapshot when ready.");
        } else {
          setFeedback("Log in, then enter an account id to get started.");
        }
      })();

      dom.rowsBody.addEventListener("click", (event) => {
        const button = event.target.closest("[data-toggle-details]");
        if (!button) return;
        const targetId = button.dataset.toggleDetails;
        const detailRow = document.getElementById(targetId);
        if (!detailRow) return;
        const isHidden = detailRow.classList.contains("is-hidden");
        detailRow.classList.toggle("is-hidden", !isHidden);
        button.setAttribute("aria-expanded", String(isHidden));
        button.textContent = isHidden ? "v" : ">";
      });
    </script>
  </body>
</html>
